<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MXCEL OS 6</title>
  <link rel="icon" type="image/x-icon" href="Win7Xcel.png">
  <style>
    /* ----- BASE STYLES ----- */
    body {
      margin: 0;
      padding: 0;
      background: url('https://platform.theverge.com/wp-content/uploads/sites/2/chorus/uploads/chorus_asset/file/22661975/img24.jpg?quality=90&strip=all') no-repeat center center fixed;
      background-size: cover;
      font-family: "Segoe UI", sans-serif;
      overflow: hidden;
    }

    /* ----- GLASSMORPHISM MIXIN ----- */
    .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    /* ----- TASKBAR ----- */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      box-shadow: 0px -3px 5px rgba(0, 0, 0, 0.5);
      background: rgba(20, 20, 20, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .taskbar img {
      width: 30px;
      height: 30px;
      cursor: pointer;
      margin-right: 10px;
    }

    /* ----- DESKTOP ICONS ----- */
    .desktop {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      gap: 10px;
      height: calc(100% - 40px);
    }
    .icon {
      text-align: center;
      cursor: pointer;
      color: white;
      width: 80px;
    }
    .icon img {
      width: 50px;
      height: 50px;
    }

    /* ----- WINDOWS ----- */
    .window {
      position: absolute;
      width: 800px;
      height: 600px;
      display: none;
      top: 100px;
      left: 100px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
      border-radius: 4px;
    }
    .window .title-bar {
      background: rgba(0, 120, 215, 0.8);
      color: white;
      padding: 5px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .window .title-bar button {
      background: red;
      color: white;
      border: none;
      cursor: pointer;
      width: 20px;
      height: 20px;
      font-weight: bold;
      line-height: 18px;
      text-align: center;
      padding: 0;
      margin-left: 5px;
      border-radius: 2px;
    }
    .window .content {
      padding: 10px;
      height: calc(100% - 30px);
      overflow: auto;
    }
    .resize-handle {
      width: 10px;
      height: 10px;
      background: gray;
      position: absolute;
      bottom: 0;
      right: 0;
      cursor: nwse-resize;
    }

    /* ----- CUSTOM CONTEXT MENU ----- */
    #custom-context-menu {
      position: absolute;
      display: none;
      z-index: 10000;
      padding: 5px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    #custom-context-menu div {
      cursor: pointer;
      padding: 3px 10px;
      border-radius: 2px;
    }
    #custom-context-menu div:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ----- APP STORE CARDS ----- */
    #app-store-list > div {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <div class="desktop"></div>

  <div class="taskbar">
    <img src="https://img.icons8.com/ios_filled/512/FA5252/windows-10.png" alt="Start Menu" onclick="alert('Start Menu not implemented yet!')" />
  </div>
  
  <!-- Custom Context Menu -->
  <div id="custom-context-menu">
    <div id="delete-option">Delete</div>
  </div>

  <!-- Include external file that defines appList -->
  <script src="apps.js"></script>

  <script>
    // Load installed states from localStorage.
    function loadInstalledApps() {
      const saved = localStorage.getItem('installedApps');
      if (saved) {
        const installedApps = JSON.parse(saved);
        appList.forEach(app => {
          if (installedApps.hasOwnProperty(app.name)) {
            app.installed = installedApps[app.name];
          }
        });
      }
    }

    // Save installed states to localStorage.
    function saveInstalledApps() {
      const installedApps = {};
      appList.forEach(app => {
        installedApps[app.name] = app.installed;
      });
      localStorage.setItem('installedApps', JSON.stringify(installedApps));
    }

    // Render desktop icons only for installed apps.
    function renderDesktopIcons() {
      const desktop = document.querySelector('.desktop');
      desktop.innerHTML = '';
      appList.filter(app => app.installed).forEach(app => {
        const iconDiv = document.createElement('div');
        iconDiv.classList.add('icon');
        iconDiv.ondblclick = () => openApp(app.name.toLowerCase());
        iconDiv.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          if (!app.preinstalled) {
            showContextMenu(e.pageX, e.pageY, app);
          }
        });
        const img = document.createElement('img');
        img.src = app.icon;
        img.alt = app.name;
        const label = document.createElement('div');
        label.textContent = app.name;
        iconDiv.appendChild(img);
        iconDiv.appendChild(label);
        desktop.appendChild(iconDiv);
      });
    }

    // Render taskbar icons only for installed apps.
    function renderTaskbarIcons() {
      const taskbar = document.querySelector('.taskbar');
      while (taskbar.children.length > 1) taskbar.removeChild(taskbar.lastChild);
      appList.filter(app => app.installed).forEach(app => {
        const img = document.createElement('img');
        img.src = app.icon;
        img.alt = app.name;
        img.title = app.name;
        img.ondblclick = () => openApp(app.name.toLowerCase());
        img.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          if (!app.preinstalled) showContextMenu(e.pageX, e.pageY, app);
        });
        taskbar.appendChild(img);
      });
    }

    // Open or create app window.
    function openApp(appId) {
      const app = appList.find(a => a.name.toLowerCase() === appId);
      if (!app) return console.error("App not found: " + appId);
      let appWindow = document.getElementById(appId);
      if (!appWindow) appWindow = createAppWindow(app);
      else {
        appWindow.style.display = 'block';
        if (app.name.toLowerCase() === 'app store') renderAppStoreList();
      }
    }

    // Create app window container.
    function createAppWindow(app) {
      const win = document.createElement('div');
      win.classList.add('window'); win.id = app.name.toLowerCase(); win.style.display='block';
      const titleBar = document.createElement('div'); titleBar.classList.add('title-bar'); titleBar.textContent = app.name;
      const closeBtn = document.createElement('button'); closeBtn.textContent='X'; closeBtn.onclick=() => win.style.display='none'; titleBar.appendChild(closeBtn);
      const content = document.createElement('div'); content.classList.add('content');
      if (app.name.toLowerCase()==='settings') content.innerHTML=`<h3>Change Background</h3><input type="text" id="bg-url" placeholder="Enter image URL (PNG, GIF, etc.)"><button onclick="changeBackground()">Apply</button>`;
      else if (app.name.toLowerCase()==='app store'){ content.innerHTML=`<h3>App Store</h3><div id="app-store-list"></div>`; setTimeout(renderAppStoreList,0);} 
      else { const iframe=document.createElement('iframe'); iframe.src=app.content; iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='none'; content.appendChild(iframe); }
      const resizeHandle=document.createElement('div'); resizeHandle.classList.add('resize-handle');
      win.appendChild(titleBar); win.appendChild(content); win.appendChild(resizeHandle); document.body.appendChild(win);
      makeDraggableAndResizable(win);
      return win;
    }

    // Drag & resize logic.
    function makeDraggableAndResizable(win){
      let drag=false, resize=false, startX, startY, startW, startH, offsetX, offsetY;
      const bar=win.querySelector('.title-bar'), handle=win.querySelector('.resize-handle');
      bar.onmousedown=e=>{drag=true; offsetX=e.clientX-win.offsetLeft; offsetY=e.clientY-win.offsetTop;};
      handle.onmousedown=e=>{resize=true; startX=e.clientX; startY=e.clientY; startW=win.offsetWidth; startH=win.offsetHeight; e.stopPropagation();};
      document.addEventListener('mousemove',e=>{
        if(drag){win.style.left=(e.clientX-offsetX)+'px'; win.style.top=(e.clientY-offsetY)+'px';}
        if(resize){win.style.width=startW+(e.clientX-startX)+'px'; win.style.height=startH+(e.clientY-startY)+'px';}
      });
      document.addEventListener('mouseup',()=>{drag=resize=false;});
    }

    // Background changer.
    function changeBackground(){ const url=document.getElementById('bg-url').value; if(url){localStorage.setItem('wallpaper',url); document.body.style.backgroundImage=`url('${url}')`; }}

    // App Store list.
    function renderAppStoreList(){
      const list=document.getElementById('app-store-list'); if(!list) return; list.innerHTML='';
      const avail=appList.filter(a=>!a.installed && a.name.toLowerCase()!=='app store');
      if(!avail.length) return list.innerHTML='<p>All apps are installed.</p>';
      avail.forEach(app=>{
        const card=document.createElement('div');
        const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center';
        const img=document.createElement('img'); img.src=app.icon; img.style.width='40px'; img.style.height='40px'; img.style.marginRight='10px';
        const name=document.createElement('span'); name.textContent=app.name; name.style.fontWeight='bold';
        row.appendChild(img); row.appendChild(name);
        const desc=document.createElement('div'); desc.textContent=app.description; desc.style.fontSize='12px'; desc.style.color='#555'; desc.style.marginTop='5px';
        const btn=document.createElement('button'); btn.textContent='Install'; btn.style.marginTop='10px'; btn.onclick=()=>{app.installed=true; saveInstalledApps(); renderDesktopIcons(); renderTaskbarIcons(); renderAppStoreList();};
        card.appendChild(row); card.appendChild(desc); card.appendChild(btn); list.appendChild(card);
      });
    }

    // Context menu logic.
    let currentApp=null;
    function showContextMenu(x,y,app){currentApp=app; const m=document.getElementById('custom-context-menu'); m.style.left=x+'px'; m.style.top=y+'px'; m.style.display='block';}
    function hideContextMenu(){const m=document.getElementById('custom-context-menu'); m.style.display='none'; currentApp=null;}
    document.getElementById('delete-option').addEventListener('click',()=>{if(currentApp&&!currentApp.preinstalled){currentApp.installed=false; saveInstalledApps(); renderDesktopIcons(); renderTaskbarIcons(); renderAppStoreList();} hideContextMenu();});
    document.getElementById('custom-context-menu').addEventListener('click',e=>e.stopPropagation());
    document.addEventListener('click',hideContextMenu);

    // Init on load.
    window.onload=function(){
      loadInstalledApps();
      renderDesktopIcons();
      renderTaskbarIcons();
      const saved=localStorage.getItem('wallpaper');
      if(saved) document.body.style.backgroundImage=`url('${saved}')`;
    };
  </script>

</body>
</html>
