<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PeerJS Chat with Persistent ID</title>
  <style>
    body { background-color: #36393f; color: #dcddde; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h1 { margin-bottom: 10px; }
    #myPeerId { font-weight: bold; font-size: 14px; }
    #chat { margin-top: 20px; display: none; }
    #messages { list-style: none; background-color: #2f3136; padding: 10px; height: 300px; overflow-y: auto; text-align: left; margin: 0 auto 10px; max-width: 600px; }
    #messages li { margin: 5px 0; padding: 5px; border-bottom: 1px solid #555; }
    input, button { padding: 10px; margin: 5px; border: none; outline: none; }
    input { width: 300px; background-color: #40444b; color: #dcddde; }
    button { background-color: #7289da; color: white; cursor: pointer; }
    /* Popup Styles */
    #namePopup { position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    #namePopupContent { background-color: #2f3136; padding: 30px; border-radius: 10px; text-align: center; }
    #namePopupContent input { width: 200px; }
  </style>
</head>
<body>
  <!-- Display Name Popup -->
  <div id="namePopup">
    <div id="namePopupContent">
      <h2>Enter Display Name</h2>
      <input type="text" id="displayNameInput" placeholder="Your name">
      <br><button id="saveNameBtn">Save</button>
    </div>
  </div>

  <h1>Simple PeerJS Chat</h1>
  <p>Share your Peer ID with your friend. Then paste your friend's ID below to connect.</p>
  <p>Your Peer ID: <span id="myPeerId">...</span></p>
  <button id="changeNameBtn">Change Display Name</button>
  <br><br>
  <input type="text" id="peerIdInput" placeholder="Enter peer ID to connect">
  <button id="connectBtn">Connect</button>

  <div id="chat">
    <ul id="messages"></ul>
    <input type="text" id="messageInput" placeholder="Type your message">
    <button id="sendBtn">Send</button>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    // Desktop Notifications
    if ('Notification' in window) Notification.requestPermission();

    // Display name
    let yourName = localStorage.getItem('displayName');
    const namePopup = document.getElementById('namePopup');
    const displayNameInput = document.getElementById('displayNameInput');
    document.getElementById('saveNameBtn').onclick = () => {
      const v = displayNameInput.value.trim(); if (v) { yourName = v; localStorage.setItem('displayName', v); namePopup.style.display = 'none'; }
    };
    document.getElementById('changeNameBtn').onclick = () => { displayNameInput.value = yourName || ''; namePopup.style.display = 'flex'; };
    if (!yourName) { namePopup.style.display = 'flex'; }

    // Persistent Peer ID
    let savedId = localStorage.getItem('peerId');
    if (!savedId) {
      savedId = 'id-' + Math.random().toString(36).slice(2,6);
      localStorage.setItem('peerId', savedId);
    }
    const peer = new Peer(savedId);
    const myPeerIdSpan = document.getElementById('myPeerId');
    myPeerIdSpan.textContent = '...';

    // Auto-reconnect logic
    peer.on('open', id => {
      myPeerIdSpan.textContent = id;
      // Attempt reconnection to last remote
      const lastRemote = localStorage.getItem('lastRemote');
      if (lastRemote) connectToPeer(lastRemote);
    });
    peer.on('disconnected', () => {
      console.log('Disconnected, retrying...');
      peer.reconnect();
    });

    let conn, peerName = 'Peer';
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.onclick = () => {
      const remote = document.getElementById('peerIdInput').value.trim();
      if (remote) connectToPeer(remote);
    };

    function connectToPeer(remote) {
      if (conn && conn.open) conn.close();
      conn = peer.connect(remote);
      localStorage.setItem('lastRemote', remote);
      conn.on('open', () => {
        setupConnection();
        conn.send(JSON.stringify({ type:'intro', name: yourName }));
        showNotification('Connected', `Connected to ${remote}`);
      });
    }

    function setupConnection() {
      document.getElementById('chat').style.display = 'block';
      conn.on('data', data => {
        try {
          const msg = JSON.parse(data);
          if (msg.type === 'intro') peerName = msg.name;
          if (msg.type === 'message') displayMessage(`${peerName}: ${msg.text}`);
        } catch(e){}
      });
    }

    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (text && conn && conn.open) {
        conn.send(JSON.stringify({ type:'message', text }));
        displayMessage(`${yourName}: ${text}`);
        input.value = '';
      }
    };
    document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key==='Enter') document.getElementById('sendBtn').click(); });

    function displayMessage(msg) {
      const li = document.createElement('li'); li.textContent = msg;
      document.getElementById('messages').appendChild(li);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      if (Notification.permission==='granted' && document.hidden) showNotification('New Message', msg);
    }

    function showNotification(title, body) {
      if (Notification.permission==='granted') new Notification(title, { body });
    }
  </script>
</body>
</html>
